version: 1
backend:
  phases:
    build:
      commands:
        - echo "Starting backend deployment..."
        - export AWS_ACCOUNT_ID=313549094027
        - echo "AWS Account ID is $AWS_ACCOUNT_ID"
        - echo "Region is $AWS_DEFAULT_REGION"
        - echo "Creating DynamoDB table..."
        - |
          aws dynamodb create-table \
            --table-name Users \
            --attribute-definitions \
              AttributeName=id,AttributeType=S \
              AttributeName=email,AttributeType=S \
            --key-schema AttributeName=id,KeyType=HASH \
            --global-secondary-indexes \
              'IndexName=EmailIndex,KeySchema=[{AttributeName=email,KeyType=HASH}],Projection={ProjectionType=ALL},BillingMode=PAY_PER_REQUEST' \
            --billing-mode PAY_PER_REQUEST \
            --region $AWS_DEFAULT_REGION 2>/dev/null || echo "DynamoDB table already exists"
        - echo "Creating minimal Lambda package..."
        - mkdir lambda-package
        - cp server/aws-index.js lambda-package/
        - cp server/package-lambda.json lambda-package/package.json
        - cd lambda-package
        - npm install --production --silent
        - zip -r ../backend.zip . >/dev/null
        - cd ..
        - rm -rf lambda-package
        - echo "Creating Lambda function with timeout..."
        - |
          timeout 120 aws lambda create-function \
            --function-name medical-app-working \
            --runtime nodejs18.x \
            --role arn:aws:iam::$AWS_ACCOUNT_ID:role/amplifyconsole-backend-role \
            --handler aws-index.handler \
            --zip-file fileb://backend.zip \
            --environment Variables="{JWT_SECRET=medical-secret-2024}" \
            --timeout 30 \
            --memory-size 256 \
            --region $AWS_DEFAULT_REGION || \
          timeout 60 aws lambda update-function-code \
            --function-name medical-app-working \
            --zip-file fileb://backend.zip \
            --region $AWS_DEFAULT_REGION
        - echo "Lambda function created successfully"
        - echo "Creating API Gateway..."
        - |
          API_ID=$(timeout 60 aws apigatewayv2 create-api \
            --name medical-simple-api-$(date +%s) \
            --protocol-type HTTP \
            --cors-configuration AllowOrigins="*",AllowMethods="*",AllowHeaders="*" \
            --region $AWS_DEFAULT_REGION \
            --query ApiId --output text)
          echo "Created API with ID: $API_ID"
          if [ "$API_ID" = "" ] || [ "$API_ID" = "None" ]; then
            echo "ERROR: Failed to create API Gateway"
            exit 1
          fi
        - |
          INTEGRATION_ID=$(aws apigatewayv2 create-integration \
            --api-id $API_ID \
            --integration-type AWS_PROXY \
            --integration-uri arn:aws:lambda:$AWS_DEFAULT_REGION:$AWS_ACCOUNT_ID:function:medical-app-working \
            --payload-format-version 2.0 \
            --region $AWS_DEFAULT_REGION \
            --query IntegrationId --output text)
          echo "Created integration with ID: $INTEGRATION_ID"
        - |
          aws apigatewayv2 create-route \
            --api-id $API_ID \
            --route-key 'ANY /{proxy+}' \
            --target integrations/$INTEGRATION_ID \
            --region $AWS_DEFAULT_REGION
          
          aws apigatewayv2 create-stage \
            --api-id $API_ID \
            --stage-name prod \
            --auto-deploy \
            --region $AWS_DEFAULT_REGION
        - |
          aws lambda add-permission \
            --function-name medical-app-working \
            --statement-id api-gateway-permission \
            --action lambda:InvokeFunction \
            --principal apigateway.amazonaws.com \
            --source-arn "arn:aws:execute-api:$AWS_DEFAULT_REGION:$AWS_ACCOUNT_ID:$API_ID/*/*" \
            --region $AWS_DEFAULT_REGION 2>/dev/null || echo "Permission already exists"
        - echo "Backend API URL is https://$API_ID.execute-api.$AWS_DEFAULT_REGION.amazonaws.com/prod"
        - echo "REACT_APP_API_URL=https://$API_ID.execute-api.$AWS_DEFAULT_REGION.amazonaws.com/prod" > client/.env.production
        - echo "API URL written to client/.env.production:"
        - cat client/.env.production
        - echo "âœ… Backend deployment complete!"
frontend:
  phases:
    preBuild:
      commands:
        - cd client
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: client/build
    files:
      - '**/*'
  cache:
    paths:
      - client/node_modules/**/*