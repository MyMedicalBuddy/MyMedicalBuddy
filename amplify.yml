version: 1
backend:
  phases:
    build:
      commands:
        - echo "Deploying backend..."
        - aws dynamodb create-table --table-name Users --attribute-definitions AttributeName=id,AttributeType=S AttributeName=email,AttributeType=S --key-schema AttributeName=id,KeyType=HASH --global-secondary-indexes 'IndexName=EmailIndex,KeySchema=[{AttributeName=email,KeyType=HASH}],Projection={ProjectionType=ALL},BillingMode=PAY_PER_REQUEST' --billing-mode PAY_PER_REQUEST --region $AWS_DEFAULT_REGION || true
        - cd server
        - npm install --production
        - zip -r ../backend.zip .
        - cd ..
        - aws lambda create-function --function-name medical-app-$AWS_BRANCH --runtime nodejs18.x --role arn:aws:iam::$AWS_ACCOUNT_ID:role/amplify-lambda-role --handler aws-index.handler --zip-file fileb://backend.zip --region $AWS_DEFAULT_REGION || aws lambda update-function-code --function-name medical-app-$AWS_BRANCH --zip-file fileb://backend.zip --region $AWS_DEFAULT_REGION
        - API_ID=$(aws apigatewayv2 create-api --name medical-api-$AWS_BRANCH --protocol-type HTTP --cors-configuration AllowOrigins="*",AllowMethods="*",AllowHeaders="*" --region $AWS_DEFAULT_REGION --query ApiId --output text)
        - INTEGRATION_ID=$(aws apigatewayv2 create-integration --api-id $API_ID --integration-type AWS_PROXY --integration-uri arn:aws:lambda:$AWS_DEFAULT_REGION:$AWS_ACCOUNT_ID:function:medical-app-$AWS_BRANCH --payload-format-version 2.0 --region $AWS_DEFAULT_REGION --query IntegrationId --output text)
        - aws apigatewayv2 create-route --api-id $API_ID --route-key 'ANY /{proxy+}' --target integrations/$INTEGRATION_ID --region $AWS_DEFAULT_REGION
        - aws apigatewayv2 create-stage --api-id $API_ID --stage-name prod --auto-deploy --region $AWS_DEFAULT_REGION
        - aws lambda add-permission --function-name medical-app-$AWS_BRANCH --statement-id api-gateway --action lambda:InvokeFunction --principal apigateway.amazonaws.com --source-arn "arn:aws:execute-api:$AWS_DEFAULT_REGION:$AWS_ACCOUNT_ID:$API_ID/*/*" --region $AWS_DEFAULT_REGION || true
        - echo "REACT_APP_API_URL=https://$API_ID.execute-api.$AWS_DEFAULT_REGION.amazonaws.com/prod" > client/.env.production
frontend:
  phases:
    preBuild:
      commands:
        - cd client
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: client/build
    files:
      - '**/*'
  cache:
    paths:
      - client/node_modules/**/*